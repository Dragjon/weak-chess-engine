#include "chess.hpp"
#include "bitboard.hpp"

using namespace chess;
using namespace std;

// Entire evaluation function is tuned with non other than Gedas' Texel tuner <3
// https://github.com/GediminasMasaitis/texel-tuner

// Helper: LSB index
int32_t lsb(uint64_t bb) {
    assert(bb != 0);
    return __builtin_ctzll(bb);
}

// Helper: Pop LSB and return its index
int32_t pop_lsb(uint64_t &bb) {
    assert(bb != 0);
    int32_t index = __builtin_ctzll(bb);
    bb &= bb - 1; // Clear the LSB
    return index;
}

// Passed pawn masks
const uint64_t WHITE_PASSED_MASK[64] = {
    217020518514230016ull,    506381209866536704ull,
    1012762419733073408ull,    2025524839466146816ull,
    4051049678932293632ull,    8102099357864587264ull,
    16204198715729174528ull,    13889313184910721024ull,
    217020518514229248ull,    506381209866534912ull,
    1012762419733069824ull,    2025524839466139648ull,
    4051049678932279296ull,    8102099357864558592ull,
    16204198715729117184ull,    13889313184910671872ull,
    217020518514032640ull,    506381209866076160ull,
    1012762419732152320ull,    2025524839464304640ull,
    4051049678928609280ull,    8102099357857218560ull,
    16204198715714437120ull,    13889313184898088960ull,
    217020518463700992ull,    506381209748635648ull,
    1012762419497271296ull,    2025524838994542592ull,
    4051049677989085184ull,    8102099355978170368ull,
    16204198711956340736ull,    13889313181676863488ull,
    217020505578799104ull,    506381179683864576ull,
    1012762359367729152ull,    2025524718735458304ull,
    4051049437470916608ull,    8102098874941833216ull,
    16204197749883666432ull,    13889312357043142656ull,
    217017207043915776ull,    506373483102470144ull,
    1012746966204940288ull,    2025493932409880576ull,
    4050987864819761152ull,    8101975729639522304ull,
    16203951459279044608ull,    13889101250810609664ull,
    216172782113783808ull,    504403158265495552ull,
    1008806316530991104ull,    2017612633061982208ull,
    4035225266123964416ull,    8070450532247928832ull,
    16140901064495857664ull,    13835058055282163712ull,
    0ull,    0ull,
    0ull,    0ull,
    0ull,    0ull,
    0ull,    0ull
};

const uint64_t BLACK_PASSED_MASK[64] = {
    0ull,    0ull,
    0ull,    0ull,
    0ull,    0ull,
    0ull,    0ull,
    3ull,    7ull,
    14ull,    28ull,
    56ull,    112ull,
    224ull,    192ull,
    771ull,    1799ull,
    3598ull,    7196ull,
    14392ull,    28784ull,
    57568ull,    49344ull,
    197379ull,    460551ull,
    921102ull,    1842204ull,
    3684408ull,    7368816ull,
    14737632ull,    12632256ull,
    50529027ull,    117901063ull,
    235802126ull,    471604252ull,
    943208504ull,    1886417008ull,
    3772834016ull,    3233857728ull,
    12935430915ull,    30182672135ull,
    60365344270ull,    120730688540ull,
    241461377080ull,    482922754160ull,
    965845508320ull,    827867578560ull,
    3311470314243ull,    7726764066567ull,
    15453528133134ull,    30907056266268ull,
    61814112532536ull,    123628225065072ull,
    247256450130144ull,    211934100111552ull,
    847736400446211ull,    1978051601041159ull,
    3956103202082318ull,    7912206404164636ull,
    15824412808329272ull,    31648825616658544ull,
    63297651233317088ull,    54255129628557504ull
};

const uint64_t OUTER_2_SQ_RING_MASK[64] = {
    289363972639948800ull,    578729044791525376ull,
    1229798258109317120ull,    2459596516218634240ull,
    4919193032437268480ull,    9838386064874536960ull,
    1157688987024883712ull,    2315096499073056768ull,
    289360704169836544ull,    578721412634640384ull,
    1229782998090514432ull,    2459565996181028864ull,
    4919131992362057728ull,    9838263984724115456ull,
    1157443727212412928ull,    2314886354913198080ull,
    505533473516158976ull,    1083124541087023104ull,
    2238589255012057088ull,    4477178510024114176ull,
    8954357020048228352ull,    17908714040096456704ull,
    17298343833662128128ull,    16149943589319737344ull,
    1974740130922496ull,    4230955238621184ull,
    8744489277390848ull,    17488978554781696ull,
    34977957109563392ull,    69955914219126784ull,
    67571655600242688ull,    63085717145780224ull,
    7713828636416ull,    16527168900864ull,
    34158161239808ull,    68316322479616ull,
    136632644959232ull,    273265289918464ull,
    263951779688448ull,    246428582600704ull,
    30132143111ull,    64559253519ull,
    133430317343ull,    266860634686ull,
    533721269372ull,    1067442538744ull,
    1031061639408ull,    962611650784ull,
    117703684ull,    252184584ull,
    521212177ull,    1042424354ull,
    2084848708ull,    4169697416ull,
    4027584528ull,    3760201760ull,
    459780ull,    985096ull,
    2035985ull,    4071970ull,
    8143940ull,    16287880ull,
    15732752ull,    14688288ull
};

const uint64_t WHITE_AHEAD_MASK[64] = {
    72340172838076672ull,    144680345676153344ull,
    289360691352306688ull,    578721382704613376ull,
    1157442765409226752ull,    2314885530818453504ull,
    4629771061636907008ull,    9259542123273814016ull,
    72340172838076416ull,    144680345676152832ull,
    289360691352305664ull,    578721382704611328ull,
    1157442765409222656ull,    2314885530818445312ull,
    4629771061636890624ull,    9259542123273781248ull,
    72340172838010880ull,    144680345676021760ull,
    289360691352043520ull,    578721382704087040ull,
    1157442765408174080ull,    2314885530816348160ull,
    4629771061632696320ull,    9259542123265392640ull,
    72340172821233664ull,    144680345642467328ull,
    289360691284934656ull,    578721382569869312ull,
    1157442765139738624ull,    2314885530279477248ull,
    4629771060558954496ull,    9259542121117908992ull,
    72340168526266368ull,    144680337052532736ull,
    289360674105065472ull,    578721348210130944ull,
    1157442696420261888ull,    2314885392840523776ull,
    4629770785681047552ull,    9259541571362095104ull,
    72339069014638592ull,    144678138029277184ull,
    289356276058554368ull,    578712552117108736ull,
    1157425104234217472ull,    2314850208468434944ull,
    4629700416936869888ull,    9259400833873739776ull,
    72057594037927936ull,    144115188075855872ull,
    288230376151711744ull,    576460752303423488ull,
    1152921504606846976ull,    2305843009213693952ull,
    4611686018427387904ull,    9223372036854775808ull,
    0ull,    0ull,
    0ull,    0ull,
    0ull,    0ull,
    0ull,    0ull
};

const uint64_t BLACK_AHEAD_MASK[64] = {
    0ull,    0ull,
    0ull,    0ull,
    0ull,    0ull,
    0ull,    0ull,
    1ull,    2ull,
    4ull,    8ull,
    16ull,    32ull,
    64ull,    128ull,
    257ull,    514ull,
    1028ull,    2056ull,
    4112ull,    8224ull,
    16448ull,    32896ull,
    65793ull,    131586ull,
    263172ull,    526344ull,
    1052688ull,    2105376ull,
    4210752ull,    8421504ull,
    16843009ull,    33686018ull,
    67372036ull,    134744072ull,
    269488144ull,    538976288ull,
    1077952576ull,    2155905152ull,
    4311810305ull,    8623620610ull,
    17247241220ull,    34494482440ull,
    68988964880ull,    137977929760ull,
    275955859520ull,    551911719040ull,
    1103823438081ull,    2207646876162ull,
    4415293752324ull,    8830587504648ull,
    17661175009296ull,    35322350018592ull,
    70644700037184ull,    141289400074368ull,
    282578800148737ull,    565157600297474ull,
    1130315200594948ull,    2260630401189896ull,
    4521260802379792ull,    9042521604759584ull,
    18085043209519168ull,    36170086419038336ull
};

const uint64_t WHITE_FRONT_MASK[64] = {
    256ull,    512ull,
    1024ull,    2048ull,
    4096ull,    8192ull,
    16384ull,    32768ull,
    65536ull,    131072ull,
    262144ull,    524288ull,
    1048576ull,    2097152ull,
    4194304ull,    8388608ull,
    16777216ull,    33554432ull,
    67108864ull,    134217728ull,
    268435456ull,    536870912ull,
    1073741824ull,    2147483648ull,
    4294967296ull,    8589934592ull,
    17179869184ull,    34359738368ull,
    68719476736ull,    137438953472ull,
    274877906944ull,    549755813888ull,
    1099511627776ull,    2199023255552ull,
    4398046511104ull,    8796093022208ull,
    17592186044416ull,    35184372088832ull,
    70368744177664ull,    140737488355328ull,
    281474976710656ull,    562949953421312ull,
    1125899906842624ull,    2251799813685248ull,
    4503599627370496ull,    9007199254740992ull,
    18014398509481984ull,    36028797018963968ull,
    72057594037927936ull,    144115188075855872ull,
    288230376151711744ull,    576460752303423488ull,
    1152921504606846976ull,    2305843009213693952ull,
    4611686018427387904ull,    9223372036854775808ull,
    0ull,    0ull,
    0ull,    0ull,
    0ull,    0ull,
    0ull,    0ull
};

const uint64_t BLACK_FRONT_MASK[64] = {
    0ull,    0ull,
    0ull,    0ull,
    0ull,    0ull,
    0ull,    0ull,
    1ull,    2ull,
    4ull,    8ull,
    16ull,    32ull,
    64ull,    128ull,
    256ull,    512ull,
    1024ull,    2048ull,
    4096ull,    8192ull,
    16384ull,    32768ull,
    65536ull,    131072ull,
    262144ull,    524288ull,
    1048576ull,    2097152ull,
    4194304ull,    8388608ull,
    16777216ull,    33554432ull,
    67108864ull,    134217728ull,
    268435456ull,    536870912ull,
    1073741824ull,    2147483648ull,
    4294967296ull,    8589934592ull,
    17179869184ull,    34359738368ull,
    68719476736ull,    137438953472ull,
    274877906944ull,    549755813888ull,
    1099511627776ull,    2199023255552ull,
    4398046511104ull,    8796093022208ull,
    17592186044416ull,    35184372088832ull,
    70368744177664ull,    140737488355328ull,
    281474976710656ull,    562949953421312ull,
    1125899906842624ull,    2251799813685248ull,
    4503599627370496ull,    9007199254740992ull,
    18014398509481984ull,    36028797018963968ull
};

const uint64_t NOT_KINGSIDE_HALF_MASK[64] = {
    17361641481138401520ull,    17361641481138401520ull,
    17361641481138401520ull,    17361641481138401520ull,
    1085102592571150095ull,    1085102592571150095ull,
    1085102592571150095ull,    1085102592571150095ull,
    17361641481138401520ull,    17361641481138401520ull,
    17361641481138401520ull,    17361641481138401520ull,
    1085102592571150095ull,    1085102592571150095ull,
    1085102592571150095ull,    1085102592571150095ull,
    17361641481138401520ull,    17361641481138401520ull,
    17361641481138401520ull,    17361641481138401520ull,
    1085102592571150095ull,    1085102592571150095ull,
    1085102592571150095ull,    1085102592571150095ull,
    17361641481138401520ull,    17361641481138401520ull,
    17361641481138401520ull,    17361641481138401520ull,
    1085102592571150095ull,    1085102592571150095ull,
    1085102592571150095ull,    1085102592571150095ull,
    17361641481138401520ull,    17361641481138401520ull,
    17361641481138401520ull,    17361641481138401520ull,
    1085102592571150095ull,    1085102592571150095ull,
    1085102592571150095ull,    1085102592571150095ull,
    17361641481138401520ull,    17361641481138401520ull,
    17361641481138401520ull,    17361641481138401520ull,
    1085102592571150095ull,    1085102592571150095ull,
    1085102592571150095ull,    1085102592571150095ull,
    17361641481138401520ull,    17361641481138401520ull,
    17361641481138401520ull,    17361641481138401520ull,
    1085102592571150095ull,    1085102592571150095ull,
    1085102592571150095ull,    1085102592571150095ull,
    17361641481138401520ull,    17361641481138401520ull,
    17361641481138401520ull,    17361641481138401520ull,
    1085102592571150095ull,    1085102592571150095ull,
    1085102592571150095ull,    1085102592571150095ull
};

const uint64_t LEFT_RIGHT_COLUMN_MASK[64] = {
    144680345676153346ull,    361700864190383365ull,
    723401728380766730ull,    1446803456761533460ull,
    2893606913523066920ull,    5787213827046133840ull,
    11574427654092267680ull,    4629771061636907072ull,
    144680345676153346ull,    361700864190383365ull,
    723401728380766730ull,    1446803456761533460ull,
    2893606913523066920ull,    5787213827046133840ull,
    11574427654092267680ull,    4629771061636907072ull,
    144680345676153346ull,    361700864190383365ull,
    723401728380766730ull,    1446803456761533460ull,
    2893606913523066920ull,    5787213827046133840ull,
    11574427654092267680ull,    4629771061636907072ull,
    144680345676153346ull,    361700864190383365ull,
    723401728380766730ull,    1446803456761533460ull,
    2893606913523066920ull,    5787213827046133840ull,
    11574427654092267680ull,    4629771061636907072ull,
    144680345676153346ull,    361700864190383365ull,
    723401728380766730ull,    1446803456761533460ull,
    2893606913523066920ull,    5787213827046133840ull,
    11574427654092267680ull,    4629771061636907072ull,
    144680345676153346ull,    361700864190383365ull,
    723401728380766730ull,    1446803456761533460ull,
    2893606913523066920ull,    5787213827046133840ull,
    11574427654092267680ull,    4629771061636907072ull,
    144680345676153346ull,    361700864190383365ull,
    723401728380766730ull,    1446803456761533460ull,
    2893606913523066920ull,    5787213827046133840ull,
    11574427654092267680ull,    4629771061636907072ull,
    144680345676153346ull,    361700864190383365ull,
    723401728380766730ull,    1446803456761533460ull,
    2893606913523066920ull,    5787213827046133840ull,
    11574427654092267680ull,    4629771061636907072ull
};

const uint64_t PAWN_RANDOMS[2][64] = {
    { 0x54702f45f273524c, 0x890b2f5fc450f9b1, 0x671b8d04f596ce28, 0x41be9ff947627443, 0xe6ef5a9a0193df41, 0x2cf6e392b6e8c5c7, 0xdd2ea5e3db0c5828, 0xca3ab7247f648164, 0xe38343fd157ef605, 0x04107d3c92865d74, 0x6c9f90fc226e9d09, 0xfadca4a24c3653a2, 0x4b1860703b96b193, 0x23f0e626de08973f, 0xd5d52af41b1da6f8, 0x29d6d6947b932290, 0x022ac9a6805870ee, 0xfe3bb03d4ec5c0f2, 0xafce1c4812b75b16, 0xf2d65558b223fb40, 0x0a09de26bdb519f3, 0xbe698bbb5c63b2e0, 0x913b511bec38d1da, 0x9a6ae3108e3e14c5, 0x53965ebf88c0a587, 0xc50a77a99833ff64, 0x985527c4d22c6a09, 0x5dbd0cd70d35c823, 0xbaec8044e147955f, 0xf5eb7800ea8325f2, 0x2a0a09275dbfbec0, 0x8f171abce1148d4e, 0xa3f543d596b8f685, 0x1f2e7ad5dd5995e2, 0x0f83f3ad8e045108, 0x74a58828658caa84, 0xf9dfafef613d881c, 0x603c57a38a0d6bf4, 0x97d567757a8130f6, 0x0d3413193a8adf4b, 0x0efa72250f1a5a79, 0xb76fe649746fc8b1, 0xe0c8146a878ca549, 0xe0ebe3dcd7d7a827, 0x8627dcacf289b3b3, 0xd928d585ea63d3eb, 0x9d07adb6ffaa4bb1, 0xff53069b49b9dbda, 0xfa84421168bcee11, 0xbcb8beae98ad8094, 0xaf03d1cb7ae015fe, 0xe0177e16f7e86f7e, 0x9481c7d1f66bcf4f, 0x23e30d70356e4925, 0xa6e13f54e74a3729, 0x064703057a924d1e, 0x6d5a3c55fe85c1a9, 0x3269474a97845f6c, 0x07ac631a5f5dbe7f, 0x07485810952a12fc, 0x5e783942ebe7c613, 0xb87b07562129fbee, 0xb1299621897aeb05, 0x6b5def2b36e04870 },
    { 0x8b304f0ac702565a, 0x60da8b0149c0d94d, 0xc1f64b6fe3202f51, 0x1c6b5409d3bcf5ac, 0x51045671e4355e1a, 0x3cef26086cf0ae1e, 0x80857ef15d4bc649, 0x2e4b3069e7095cd9, 0x0fd41ed22cdeb812, 0x2fb11490035becf6, 0x3d924a27081f4bab, 0x78c1ac5979508660, 0x7d7477dd708e5c32, 0x2059c3c4c1433a3a, 0x63789c923a933227, 0xa3c7e325222d4753, 0x30dcf92442cb3d4b, 0x270fd94f8f66319d, 0x4215b5f1d72ec45a, 0xd781efaef69a2927, 0xcabd50383ddd3a38, 0x2be4dd17ffa47f9a, 0xc60b3904a477284b, 0x8d886cc5b2ebe45a, 0x83117d42f9e72d1b, 0x7307f4da6de6b837, 0x63731eaf26e13268, 0x4a3a84750150920a, 0x771db813109e5a07, 0x21b5b3877a4254e6, 0xdf55ea05362471f1, 0xa0773e46125318f0, 0x755830a55797d945, 0xebb9b5cb9133bc4b, 0x53f292b95552c2d6, 0xcc13ae33837f4841, 0x3333cd9aa64598af, 0x702314b54c16440b, 0x52d6b1723b659497, 0xf62ee484a5e6b844, 0xc634fe15000f7b3a, 0x39db5baa1242a378, 0xc3edeb13991d6ee6, 0x6e1957671c56da0c, 0x1c533c15aa4dabd1, 0x1de36df403fea991, 0x2aedfa9ff198bf08, 0xffda5fae664eded9, 0x90c6679c34712e36, 0x6466340f3c4962da, 0xadda25b80601afa2, 0xd510c435559f555a, 0x488fd0b5c9c0de48, 0x33530ef32a7b2734, 0x8b99e8d6500f074e, 0xde65031a9457899b, 0xda00ca63f42e4fcd, 0x33cc4fddf6b47e52, 0x7f5a94793115ba54, 0x1111791cdd897112, 0x14e840b92bb95812, 0xce8589f7d537c827, 0xff5b9d19b4e54339, 0xe3ee0bb466747a01 }
};

// Check if square is passed pawn for white
bool is_white_passed_pawn(int32_t square, uint64_t black_pawns) {
    return (WHITE_PASSED_MASK[square] & black_pawns) == 0;
}

// Check if square is passed pawn for black
bool is_black_passed_pawn(int32_t square, uint64_t white_pawns) {
    return (BLACK_PASSED_MASK[square] & white_pawns) == 0;
}

// Get the pawn key for the current position
uint64_t get_pawn_key(const Board &board){
    uint64_t pawn_key = 0ull;
    uint64_t wp = board.pieces(PieceType::PAWN, Color::WHITE).getBits();
    uint64_t bp = board.pieces(PieceType::PAWN, Color::BLACK).getBits();
    while (wp){
        int32_t sq = pop_lsb(wp);
        pawn_key ^= PAWN_RANDOMS[board.sideToMove() == Color::WHITE ? 0 : 1][sq];
    }
    while (bp){
        int32_t sq = pop_lsb(bp);
        pawn_key ^= PAWN_RANDOMS[board.sideToMove() == Color::WHITE ? 0 : 1][sq];
    }
    return pawn_key;
}